### SQLAlchemy: Alembic Миграции Базы Данных #13

Конспект по видео - [ссылка](https://www.youtube.com/watch?v=SD6_EPg0Aqk&list=PLeLN0qH0-mCXARD_K-USF2wHctxzEVp40&index=13)

Миграции позволяют сохранять состояние базы данных, чтобы после изменений моделей можно было откатить (вернуть) предыдущее состояние.

**Добавляем миграции в проект**

`alembic init <путь до директорий с миграциями>`

Пример: `alembic init src/migrations`

Создаётся директория с миграциями и файл конфигурации - `alembic.ini`.

### alembic.ini

* script_location - путь до директории с миграциями
* prepend_sys_path - область видимости Alembic

Указываем область видимости `. src` в параметре - prepend_sys_path, чтобы корректно работали импорты.

Файл `migrations/README` можно удалить.

В migrations есть файл - `script.py.mako`, который генерирует миграции. Этот файл написан на языке **mako** (язык mako изобрёл создатель SQLAlchemy и Alembic).

Файл `migrations/env.py` нужен для конфигурации моделей и для настройки подключения к базе данных.

**Меняем адрес для подключения к базе данных и настраиваем подключение**

Прописываем код в `env.py`, который меняет параметр в конфигурации alembic.ini

`config.set_main_option("sqlalchemy.url", settings.DATABASE_URL_asyncpg  + "?async_fallback=True")`

Параметр `async_fallback` задаём **True**, чтобы не возникло ошибок с асинхронностью.

Такой способ изменения параметров, нужен чтобы значение автоматически подставлялось из конфигурации проекта. 

Меняем переменную `target_metadata` в файле `env.py` (в неё передаются все таблицы - модели данных)

* Импортируем **любую** модель из модуля `models.py` - это нужно, чтобы модели инициализировались

    Пример: `from models import WorkersOrm` (чтобы эта строчка случайно не стёрлась можно добавить комментарий - # noqa)

* Импортируем базовый класс - **Base** (в нём хранятся все метаданные)
    
    Пример: `from database import Base`

* Подставляем `Base.metadata` в переменную `target_metadata`

**Создание миграции**

`alembic revision --autogenerate -m <название миграции>` (название миграции указывать необязательно)

**Перед миграцией нужно пересоздать базу данных (база данных должна быть пустая)**

**Revision = Миграция**

Флаг `--autogenerate` **обязателен**, чтобы состояние моделей в коде сравнилось с состоянием в базе данных.

Создастся таблица - `alembic_version` в неё записываются уникальные Revision ID всех миграций.

**Загрузить миграцию в базу данных**

`alembic upgrade head <Revision ID>` (Revision ID - уникальный ID миграции указывается, если мы хотим докатиться до какой-то определённой миграции и дальше её не прогонять).

Если указать **head** (без Revision ID), то загрузятся сразу все миграции.

`alembic upgrade head`

Если в логе отображается **Running upgrade**, то миграции успешно загружены.

**Откатить состояние базы данных**

`alembic downgrade <Revision ID>` (откат до нужной миграции)

`alembic downgrade base` (откат базы данных до изначального состояния - в базе данных пропадут таблицы и `alembic_version` будет пустой, потому что база данных чистая).

**Создание своих миграций**

`alembic revision`

Создастся пустая миграция. В ней можно писать свой код. Например, создавать таблицы через обычный SQL код, вставить данные в таблицу, добавить новый столбец в таблицу.

В своих миграциях важно всегда прописывать обратное действие в downgrade, чтобы можно было откатить состояние.

В случае, если Alembic не фиксирует изменения в моделях, то их можно внести вручную через `op.execute("сырой SQL запрос")` в свою миграцию.

**Форматирование файлов миграций**

В файле `alembic.ini` можно задать форматировщика, например, библиотеку **black** (предварительно её нужно установить в репозиторий). Чтобы задать форматировщика нужно раскомментировать несколько строк кода с **black**. После этого код всех миграций будет автоматически форматироваться через black.

**Важно**

После внесения изменений в модели таблиц можно сделать миграцию, чтобы сохранить состояние базы данных.

По умолчанию Alembic фиксирует не все изменения в моделях. Для того чтобы Alembic фиксировал все изменения в моделях нужно добавить параметр `compare_server_default=True` в функции `context.configure` (файл - `env.py`).

Иногда Alembic не может загрузить миграцию и выдаёт ошибку. По этому, если появляется ошибка при загрузке миграции - нужно исправлять код миграции.

Когда мы делаем миграцию (ревизию) сравнивается состояние базы и состояние моделей и если она не совпадает с последней созданной, получим ошибку.

После создания миграции её можно удалить из директории `migrations` или сделать загрузку этой миграции (upgrade) в базу данных.

Нельзя сделать миграцию, если миграция была уже сделана и не загружена в базу данных или не удалена

